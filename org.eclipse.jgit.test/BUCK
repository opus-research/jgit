PREFIX = 'tst/org/eclipse/jgit/'
DATA = glob(['tst-rsrc/org/eclipse/jgit/test/resources/**/*'])
DFS  = glob([PREFIX + 'internal/storage/dfs/**/*Test.java'])
LIB = glob([PREFIX + '**/*Test.java'], excludes = DFS)
UTIL = glob(['tst/**/*.java'], excludes = DFS + LIB)

for test in LIB:
  e = test.index('.java')
  java_test(
    name = test[len(PREFIX):e].replace('/', '.'),
    srcs = [test],
    deps = [':test_util'],
    labels = ['lib'],
    # TODO(msohn): find out why this doesn't work if OS platform encoding is different
    vm_args = [
      '-Dfile.encoding=UTF-8'
    ]
  )

for test in DFS:
  e = test.index('.java')
  java_test(
    name = test[len(PREFIX):e].replace('/', '.'),
    srcs = [test],
    deps = [
      ':test_util',
      '//org.eclipse.jgit:storage_dfs',
    ],
    labels = ['dfs'],
  )

java_library(
  name = 'test_util',
  srcs = UTIL,
  resources = glob(['tst-rsrc/**/*'], excludes = DATA),
  deps = [
    ':sample_data_jar',
    '//org.eclipse.jgit:api',
    '//org.eclipse.jgit:blame',
    '//org.eclipse.jgit:fnmatch',
    '//org.eclipse.jgit:lib',
    '//org.eclipse.jgit:merge',
    '//org.eclipse.jgit:nls',
    '//org.eclipse.jgit:notes',
    '//org.eclipse.jgit:progress',
    '//org.eclipse.jgit:revplot',
    '//org.eclipse.jgit:text',
    '//org.eclipse.jgit:transport_client',
    '//org.eclipse.jgit:transport_server',
    '//org.eclipse.jgit:util',
    '//org.eclipse.jgit.junit:junit',
    '//lib:ewah',
    '//lib:hamcrest-core',
    '//lib:hamcrest-library',
    '//lib:junit',
    '//org.eclipse.jgit.console:console', # ConsoleText
    '//org.eclipse.jgit.pgm:pgm', # CLIText
    '//org.eclipse.jgit.ui:ui', # UIText
  ],
  export_deps = True,
  visibility = ['//tools:eclipse_classpath'],
)

prebuilt_jar(
  name = 'sample_data_jar',
  binary_jar = genfile('sample_data.jar'),
  deps = [':sample_data'],
)

genrule(
  name = 'sample_data',
  cmd = 'jar cf $OUT -C $SRCDIR/tst-rsrc org',
  srcs = DATA,
  out = 'sample_data.jar',
)
